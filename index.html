<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مشغل TS المتقدم</title>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background: #1a1a2e;
            color: #fff;
            margin: 0;
            padding: 20px;
        }
        .player-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #video-container {
            width: 100%;
            margin-top: 20px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        video {
            width: 100%;
        }
        .controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        button {
            background: #4361ee;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="player-container">
        <h1 style="text-align:center;color:#4361ee">مشغل ملفات TS</h1>
        
        <div class="input-group">
            <label for="stream-url">رابط البث (.ts)</label>
            <input type="text" id="stream-url" placeholder="https://example.com/stream.ts" style="width:100%;padding:10px;">
        </div>
        
        <div class="controls">
            <button id="play-btn">تشغيل</button>
            <button id="stop-btn">إيقاف</button>
        </div>
        
        <div id="status" class="status"></div>
        
        <div id="video-container">
            <video id="video-player" controls></video>
        </div>
    </div>

    <script>
        // العناصر الرئيسية
        const videoPlayer = document.getElementById('video-player');
        const playBtn = document.getElementById('play-btn');
        const stopBtn = document.getElementById('stop-btn');
        const statusEl = document.getElementById('status');
        
        // متغيرات المشغل
        let mediaSource;
        let sourceBuffer;
        let streamUrl;
        let isPlaying = false;
        let fetchController = new AbortController();
        
        // تشغيل البث
        playBtn.addEventListener('click', async () => {
            streamUrl = document.getElementById('stream-url').value;
            
            if (!streamUrl) {
                showStatus('الرجاء إدخال رابط البث', 'error');
                return;
            }
            
            try {
                await playTSStream(streamUrl);
                showStatus('جارٍ التشغيل...', 'success');
                isPlaying = true;
            } catch (error) {
                showStatus(`خطأ: ${error.message}`, 'error');
                console.error(error);
            }
        });
        
        // إيقاف البث
        stopBtn.addEventListener('click', () => {
            if (isPlaying) {
                fetchController.abort();
                videoPlayer.pause();
                videoPlayer.src = '';
                if (mediaSource) {
                    mediaSource.endOfStream();
                }
                isPlaying = false;
                showStatus('تم الإيقاف', 'info');
            }
        });
        
        // دالة التشغيل الرئيسية
        async function playTSStream(url) {
            // إعداد MediaSource API
            mediaSource = new MediaSource();
            videoPlayer.src = URL.createObjectURL(mediaSource);
            
            return new Promise((resolve, reject) => {
                mediaSource.addEventListener('sourceopen', async () => {
                    try {
                        // إنشاء SourceBuffer لنوع video/MP2T
                        sourceBuffer = mediaSource.addSourceBuffer('video/mp2t; codecs="avc1.42E01E, mp4a.40.2"');
                        
                        // تحميل البيانات
                        await fetchTSStream(url, sourceBuffer);
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                });
            });
        }
        
        // جلب بيانات TS
        async function fetchTSStream(url, sourceBuffer) {
            fetchController = new AbortController();
            const response = await fetch(url, {
                signal: fetchController.signal,
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
                    'Referer': 'https://example.com',
                    'Origin': 'https://example.com'
                }
            });
            
            if (!response.ok) {
                throw new Error('فشل في جلب البيانات');
            }
            
            const reader = response.body.getReader();
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                // إضافة البيانات إلى SourceBuffer
                await new Promise((resolve) => {
                    sourceBuffer.addEventListener('updateend', resolve, { once: true });
                    sourceBuffer.appendBuffer(value);
                });
            }
        }
        
        // عرض الحالة
        function showStatus(message, type) {
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            statusEl.style.background = 
                type === 'error' ? 'rgba(255,0,0,0.2)' :
                type === 'success' ? 'rgba(0,255,0,0.2)' :
                'rgba(255,255,255,0.1)';
        }
        
        // معالجة الأخطاء
        videoPlayer.addEventListener('error', () => {
            showStatus('حدث خطأ في التشغيل', 'error');
        });
    </script>
</body>
</html>
